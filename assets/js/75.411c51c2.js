(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{629:function(t,s,a){"use strict";a.r(s);var l=a(35),c=Object(l.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"cuda-out-of-memory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cuda-out-of-memory"}},[t._v("#")]),t._v(" CUDA Out of Memory")]),t._v(" "),a("p",[t._v("一般直接使用 PyTorch 提供的快照功能")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://pytorch.org/docs/stable/torch_cuda_memory.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pytorch.org/docs/stable/torch_cuda_memory.html"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{staticClass:"shiki github-light",staticStyle:{"background-color":"#fff"},attrs:{tabindex:"0"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#6A737D"}},[t._v("# enable memory history, which will add tracebacks and event history to snapshots")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("torch.cuda.memory._record_memory_history()")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("run_your_code()")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("torch.cuda.memory._dump_snapshot(")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"my_snapshot.pickle"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"})])])]),a("p",[a("a",{attrs:{href:"https://pytorch.org/memory_viz",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pytorch.org/memory_viz"),a("OutboundLink")],1)]),t._v(" "),a("hr"),t._v(" "),a("h2",{attrs:{id:"其它方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其它方法"}},[t._v("#")]),t._v(" 其它方法")]),t._v(" "),a("h3",{attrs:{id:"鸵鸟法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#鸵鸟法"}},[t._v("#")]),t._v(" 鸵鸟法")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{staticClass:"shiki github-light",staticStyle:{"background-color":"#fff"},attrs:{tabindex:"0"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#D73A49"}},[t._v("import")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" gc")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("gc.collect()")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("torch.cuda.empty_cache()")])]),t._v("\n"),a("span",{staticClass:"line"})])])]),a("p",[t._v("有可能就解决了")]),t._v(" "),a("h3",{attrs:{id:"详细检查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#详细检查"}},[t._v("#")]),t._v(" 详细检查")]),t._v(" "),a("p",[t._v("一般来说是因为程序里有显存泄露，可以先查找残留的无法释放的 tensor")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{staticClass:"shiki github-light",staticStyle:{"background-color":"#fff"},attrs:{tabindex:"0"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#D73A49"}},[t._v("import")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" gc")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("gc.collect()")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("torch.cuda.empty_cache()")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#6A737D"}},[t._v("# 获取所有残留的 Tensor")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("leaked_tensors ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("=")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" [obj ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("for")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" obj ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("in")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" gc.get_objects() ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("if")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("isinstance")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(obj, torch.Tensor)]")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#6A737D"}},[t._v("# 打印详细信息")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#D73A49"}},[t._v("for")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" tensor ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("in")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" leaked_tensors:")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("    ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("if")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"cuda"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("in")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("str")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(tensor.device):")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("        size ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("=")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" tensor.element_size() ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("*")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" tensor.nelement() ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("/")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("1024")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("**")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("2")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("        ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("if")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" size ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v(">")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("10")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(":")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("print")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("f")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"Shape: ')]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("tensor.shape")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v(" | Device: ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("tensor.device")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v(" | Size: ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("size")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v(":.2f")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v(' MB"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"}),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")]),a("span",{staticStyle:{color:"#6A737D"}},[t._v("# 获取所有直接引用该 Tensor 的对象")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            referrers ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("=")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" gc.get_referrers(tensor)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("print")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("f")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"引用者数量: ')]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{len")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(referrers)")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")]),a("span",{staticStyle:{color:"#6A737D"}},[t._v("# 打印引用者的类型和关键信息")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("            ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("for")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ref ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("in")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" referrers:")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("if")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("isinstance")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref, (")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("list")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(", ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("dict")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(", ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("tuple")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")):")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                    ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("print")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("f")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"引用者类型: ')]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{type")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref)")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v(", 内容片段: ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{str")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref)[:")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("100")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("]")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('..."')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("else")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(":")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                    ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("print")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("f")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"引用者类型: ')]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{type")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref)")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                    ")]),a("span",{staticStyle:{color:"#6A737D"}},[t._v("# 如果是自定义对象，尝试获取其属性名")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                    ")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("if")]),a("span",{staticStyle:{color:"#24292E"}},[t._v(" ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("hasattr")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref, ")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"__dict__"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v("):")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("                        ")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("print")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("f")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"引用者包含属性: ')]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("{vars")]),a("span",{staticStyle:{color:"#24292E"}},[t._v("(ref).keys()")]),a("span",{staticStyle:{color:"#005CC5"}},[t._v("}")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"})])])]),a("p",[t._v("如果能发现某个 tensor 没有合理释放，但又不太容易看出哪里有残留的引用，可以使用 "),a("code",[t._v("objgraph")]),t._v(" 库来可视化（非常好用），需要安装 "),a("a",{attrs:{href:"https://graphviz.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Graphviz"),a("OutboundLink")],1),t._v("（安装好之后命令行里能调用 "),a("code",[t._v("dot")]),t._v(" 可执行文件），核心用法只有一行")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{staticClass:"shiki github-light",staticStyle:{"background-color":"#fff"},attrs:{tabindex:"0"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#24292E"}},[t._v("objgraph.show_backrefs(obj, ")]),a("span",{staticStyle:{color:"#E36209"}},[t._v("filename")]),a("span",{staticStyle:{color:"#D73A49"}},[t._v("=")]),a("span",{staticStyle:{color:"#032F62"}},[t._v('"backrefs.png"')]),a("span",{staticStyle:{color:"#24292E"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"})])])]),a("p",[t._v("可以调整 "),a("code",[t._v("max_depth")]),t._v("，"),a("code",[t._v("too_many")]),t._v(" 参数来控制可视化的详细程度")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("有时发现单独执行 "),a("code",[t._v("torch.cuda.empty_cache()")]),t._v(" 并不能释放显存，但是先执行 "),a("code",[t._v("gc.collect()")]),t._v(" 之后再执行 "),a("code",[t._v("empty_cache()")]),t._v(" 又发现的确有显存可以释放。对此 DeepSeek 的解释为")]),t._v(" "),a("blockquote",[a("ol",[a("li",[a("strong",[t._v("​Python 对象层")]),t._v("​​（由 GC 管理）\n"),a("ul",[a("li",[t._v("当 Python 中 "),a("code",[t._v("torch.Tensor")]),t._v(" 对象的引用计数归零时，"),a("strong",[t._v("​​仅标记")]),t._v("​​底层显存可回收")]),t._v(" "),a("li",[t._v("但 Python 的垃圾回收器（GC）可能未及时运行，导致对象未真正销毁")])])]),t._v(" "),a("li",[a("strong",[t._v("CUDA 缓存层")]),t._v("​​（由 PyTorch 管理）\n"),a("ul",[a("li",[a("code",[t._v("empty_cache()")]),t._v(" 只能释放"),a("strong",[t._v("​​已被 Python 标记为可回收")]),t._v("​​的显存")]),t._v(" "),a("li",[t._v("如果 Python 对象未销毁，PyTorch 无法感知这些显存可释放")])])])])])])}),[],!1,null,null,null);s.default=c.exports}}]);